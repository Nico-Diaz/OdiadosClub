<div id="cart-container" class="cart-wrapper hidden">
    <div class="cart-deco-top"></div>
    <div class="cart-inner">
        <div class="delivery-section">
            <label for="delivery-method" class="delivery-label">ENTREGA:</label>
            <div class="select-wrapper">
                <select id="delivery-method" class="delivery-select">
                    <option value="Take Away">ü•° RETIRO POR LOCAL</option>
                    <option value="Delivery">üõµ ENV√çO A DOMICILIO</option>
                </select>
                <span class="select-arrow">‚ñº</span>
            </div>
        </div>

        <div class="actions-section">
            <div class="left-group">
                <button id="btn-cancel" class="btn-cancel" title="Vaciar carrito">‚úï</button>
                <div class="total-info">
                    <span class="total-label">TOTAL ESTIMADO</span>
                    <span class="total-amount">$<span id="cart-total">0</span></span>
                </div>
            </div>
            
            <button id="btn-checkout" class="btn-checkout">
                CONFIRMAR <span class="arrow-icon">‚Üí</span>
            </button>
        </div>
    </div>
</div>

<script>
    // Importamos desde tu archivo 'card' (el nombre que me dijiste)
    import { cartItems } from '../store/cart'; 

    const container = document.getElementById('cart-container');
    const totalSpan = document.getElementById('cart-total');
    const checkoutBtn = document.getElementById('btn-checkout');
    const cancelBtn = document.getElementById('btn-cancel');

    // --- CORRECCI√ìN AQU√ç ---
    // Agregamos 'readonly' para que TypeScript acepte el array protegido
    cartItems.subscribe((items: readonly any[]) => {
        if (!container) return;

        if (items.length > 0) {
            container.classList.remove('hidden');
            
            const total = items.reduce((acc: number, item: any) => acc + (item.price * item.quantity), 0);
            
            if (totalSpan) totalSpan.innerText = total.toLocaleString('es-AR');
        } else {
            container.classList.add('hidden');
        }
    });

    // 2. LOGICA CANCELAR
    cancelBtn?.addEventListener('click', () => {
        if(confirm('¬øSeguro que quieres vaciar el pedido?')) {
            cartItems.set([]); 
        }
    });

    // 3. LOGICA CONFIRMAR
    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', async () => {
            const items = cartItems.get();
            if (items.length === 0) return;

            const deliverySelect = document.getElementById('delivery-method') as HTMLSelectElement;
            const deliveryMethod = deliverySelect ? deliverySelect.value : 'No especificado';

            const originalText = checkoutBtn.innerHTML;
            checkoutBtn.innerText = "ENVIANDO...";
            checkoutBtn.setAttribute('disabled', 'true');
            checkoutBtn.style.opacity = '0.7';

            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        items: items, 
                        deliveryMethod: deliveryMethod 
                    }), 
                });

                const data = await response.json();
                
                if (data.success) {
                    cartItems.set([]); 
                    window.location.href = data.redirectUrl; 
                } else {
                    alert('Error: ' + (data.error || 'Algo sali√≥ mal'));
                    restoreBtn(originalText);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexi√≥n.');
                restoreBtn(originalText);
            }
        });

        function restoreBtn(htmlContent: string) {
            if(checkoutBtn) {
                checkoutBtn.innerHTML = htmlContent;
                checkoutBtn.removeAttribute('disabled');
                checkoutBtn.style.opacity = '1';
            }
        }
    }
</script>

<style>
    /* Estilos intactos */
    .cart-wrapper { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 480px; z-index: 9999; font-family: sans-serif; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .hidden { display: none !important; }
    .cart-inner { background-color: #0f0f0f; border: 1px solid #333; box-shadow: 0 15px 40px rgba(0,0,0,0.9); display: flex; flex-direction: column; }
    .cart-deco-top { height: 4px; width: 100%; background: var(--color-red, #dc2626); box-shadow: 0 0 15px var(--color-red, #dc2626); }
    .delivery-section { background-color: #050505; padding: 8px 15px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 10px; }
    .delivery-label { font-size: 0.7rem; color: #666; font-weight: bold; letter-spacing: 1px; }
    .select-wrapper { flex-grow: 1; position: relative; }
    .delivery-select { width: 100%; background: transparent; color: white; border: none; font-size: 0.9rem; font-weight: bold; text-transform: uppercase; cursor: pointer; outline: none; text-align: right; padding-right: 20px; appearance: none; }
    .delivery-select option { background: black; }
    .select-arrow { position: absolute; right: 0; top: 50%; transform: translateY(-50%); color: var(--color-red, #dc2626); font-size: 0.7rem; pointer-events: none; }
    .actions-section { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
    .left-group { display: flex; align-items: center; gap: 15px; }
    .btn-cancel { width: 32px; height: 32px; border-radius: 50%; background: #1a1a1a; border: 1px solid #333; color: #666; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .btn-cancel:hover { background: var(--color-red, #dc2626); color: white; border-color: var(--color-red, #dc2626); transform: rotate(90deg); }
    .total-info { display: flex; flex-direction: column; }
    .total-label { font-size: 0.6rem; color: #666; letter-spacing: 1px; font-weight: bold; }
    .total-amount { font-size: 1.5rem; font-weight: 900; color: white; line-height: 1; }
    .btn-checkout { background-color: var(--color-red, #dc2626); color: white; border: none; padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 4px 0 rgba(153, 27, 27, 0.5); }
    .btn-checkout:hover { background-