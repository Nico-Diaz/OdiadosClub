<div id="cart-container" class="cart-wrapper hidden">
    <div class="cart-summary">
        <button id="btn-cancel" class="btn-cancel" aria-label="Cancelar y vaciar carrito">
            ✕
        </button>

        <span class="font-gothic text-xl ml-2">TOTAL: $<span id="cart-total">0</span></span>
        
        <button id="btn-checkout" class="btn-checkout">CONFIRMAR</button>
    </div>
</div>

<script>
    import { cartItems } from '../../store/cart';

    const container = document.getElementById('cart-container');
    const totalSpan = document.getElementById('cart-total');
    const checkoutBtn = document.getElementById('btn-checkout');
    const cancelBtn = document.getElementById('btn-cancel');

    // Escuchamos cambios en el carrito
    cartItems.subscribe(items  => {
        if (items.length > 0) {
            container?.classList.remove('hidden');
            const total = items.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            if (totalSpan) totalSpan.innerText = total.toString();
        } else {
            container?.classList.add('hidden');
        }
    });

    // 2. Lógica del Botón CANCELAR (X)
    cancelBtn?.addEventListener('click', () => {
        cartItems.set([]);
    });
        // Preguntar antes de borrar (Opcional, si quieres que sea directo borra el confirm);

    // 3. Lógica de Confirmar Pedido (Backend + WhatsApp)
    if (checkoutBtn) {
        checkoutBtn.addEventListener('click', async () => {
            const items = cartItems.get();
            if (items.length === 0) return;
            
            const originalText = checkoutBtn.innerText;
            checkoutBtn.innerText = "PROCESANDO...";
            checkoutBtn.setAttribute('disabled', 'true');
            checkoutBtn.style.opacity = '0.7';

            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items }),
                });

                const data = await response.json();
                
                if (data.success) {
                    cartItems.set([]); 
                    window.location.href = data.redirectUrl; 
                } else {
                    alert('Error: ' + (data.error || 'No se pudo procesar'));
                    resetBtn(originalText);
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión.');
                resetBtn(originalText);
            }
        });

        function resetBtn(text: string) {
            if (checkoutBtn) {
                checkoutBtn.innerText = text;
                checkoutBtn.removeAttribute('disabled');
                checkoutBtn.style.opacity = '1';
            }
        }
    }
</script>

<style>
    .cart-wrapper {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 95%; /* Un poco más ancho para que quepa la X */
        max-width: 420px;
        z-index: 1000;
        animation: slideUp 0.3s ease-out;
    }

    .hidden { display: none; }

    .cart-summary {
        background-color: var(--color-red);
        color: var(--color-black);
        padding: 0.8rem; /* Un poco menos de padding para ajustar */
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid var(--color-black);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        gap: 10px; /* Espacio entre elementos */
    }

    .btn-checkout {
        background-color: var(--color-black);
        color: var(--color-white);
        border: none;
        padding: 0.5rem 1rem;
        font-family: var(--font-gothic);
        font-size: 1.1rem;
        cursor: pointer;
        white-space: nowrap; /* Que el texto no se rompa */
        transition: opacity 0.3s;
    }

    /* ESTILO DE LA CRUZ */
    .btn-cancel {
        background: transparent;
        border: 2px solid var(--color-black);
        color: var(--color-black);
        width: 35px;
        height: 35px;
        border-radius: 50%; /* Redondo */
        font-weight: bold;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0; /* Para que no se aplaste si hay poco espacio */
    }

    .btn-cancel:hover {
        background-color: var(--color-black);
        color: var(--color-red); /* Invierte colores al pasar el mouse */
        transform: rotate(90deg); /* Efecto giratorio */
    }

    @keyframes slideUp {
        from { transform: translate(-50%, 100%); }
        to { transform: translate(-50%, 0); }
    }
</style>