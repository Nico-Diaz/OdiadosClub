---
import type { Product } from '../../data/menu-data';

interface Props {
    product: Product;
}

const { product } = Astro.props;

// Configuramos los precios aquÃ­
const EXTRA_MEAT_PRICE = 2000;
const EXTRA_CHEESE_PRICE = 1000;
---

<article 
    class="product-card" 
    data-base-price={product.price}
    data-extra-meat={EXTRA_MEAT_PRICE}
    data-extra-cheese={EXTRA_CHEESE_PRICE}
>
    
    <div class="card-upper">
        <header class="card-header">
            <h3 class="product-name font-gothic">{product.name}</h3>
            {product.isNew && <span class="badge-new">NUEVO</span>}
        </header>

        <div class="separator"></div>
        <p class="description">{product.description}</p>
    </div>

    <div class="customizer-panel">
        <div class="panel-label">PERSONALIZAR:</div>
        
        <div class="selector-row">
            <span class="option-label"><span class="icon">ðŸ¥©</span> CARNE</span>
            <div class="option-buttons meat-options">
                <button class="btn-selector active" data-type="meat" data-qty="2">DOBLE</button>
                <button class="btn-selector" data-type="meat" data-qty="3">TRIPLE</button>
            </div>
        </div>

        <div class="selector-row">
            <span class="option-label"><span class="icon">ðŸ§€</span> CHEDDAR</span>
            <div class="option-buttons cheese-options">
                <button class="btn-selector active" data-type="cheese" data-qty="2">DOBLE</button>
                <button class="btn-selector" data-type="cheese" data-qty="3">TRIPLE</button>
            </div>
        </div>
    </div>

    <footer class="card-footer">
        <div class="price-container">
            <span class="price-label">PRECIO FINAL:</span>
            <span class="price display-price">${product.price}</span>
        </div>
        
        <button 
            class="btn-add-cart"
            data-id={product.id}
            data-name={product.name}
            data-price={product.price}
            data-base-name={product.name}
        >
            AGREGAR AL PEDIDO
        </button>
    </footer>
</article>

<script>
    // Ahora sÃ­ podemos importar sin problemas porque quitamos el define:vars
    import { addProduct } from '../../store/cart';

    // Seleccionamos todas las tarjetas
    const cards = document.querySelectorAll('.product-card');

    cards.forEach(card => {
        // LEEMOS LOS DATOS DEL HTML (MÃ¡s seguro)
        const basePrice = Number(card.getAttribute('data-base-price'));
        const priceExtraMeat = Number(card.getAttribute('data-extra-meat'));
        const priceExtraCheese = Number(card.getAttribute('data-extra-cheese'));
        
        const displayPrice = card.querySelector('.display-price');
        const addButton = card.querySelector('.btn-add-cart');
        const baseName = addButton?.getAttribute('data-base-name') || '';

        // Estado inicial
        let currentMeat = 2;
        let currentCheese = 2;

        const updateCardState = () => {
            // 1. Calcular Extra
            let extraCost = 0;
            if (currentMeat === 3) extraCost += priceExtraMeat;
            if (currentCheese === 3) extraCost += priceExtraCheese;

            const finalPrice = basePrice + extraCost;

            // 2. Construir Nombre
            let details = [];
            if (currentMeat === 3) details.push("TRIPLE CARNE");
            if (currentCheese === 3) details.push("TRIPLE CHEDDAR");
            
            const finalName = details.length > 0 
                ? `${baseName} (${details.join(' + ')})` 
                : baseName;

            // 3. Actualizar UI
            if (displayPrice) displayPrice.textContent = `$${finalPrice}`;
            
            // 4. Actualizar BotÃ³n
            if (addButton) {
                addButton.setAttribute('data-price', finalPrice.toString());
                addButton.setAttribute('data-name', finalName);
            }
        };

        // Eventos Selectores
        card.querySelectorAll('.btn-selector').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.target as HTMLElement; // Forzamos tipo
                const type = target.getAttribute('data-type');
                const qty = Number(target.getAttribute('data-qty'));

                target.parentElement?.querySelectorAll('.btn-selector').forEach(b => b.classList.remove('active'));
                target.classList.add('active');

                if (type === 'meat') currentMeat = qty;
                if (type === 'cheese') currentCheese = qty;
                updateCardState();
            });
        });

        // Evento Agregar al Carrito
        addButton?.addEventListener('click', () => {
             const id = addButton.getAttribute('data-id');
             const name = addButton.getAttribute('data-name');
             const price = addButton.getAttribute('data-price');

             console.log("Intentando agregar:", name, price); // DEBUG EN CONSOLA

             let uniqueId = id;
             if (name && name.includes('(')) {
                 const variantSuffix = name.split('(')[1].replace(')', '').replace(/\s|\+/g, '').toLowerCase();
                 uniqueId = `${id}-${variantSuffix}`;
             }

             if (uniqueId && name && price) {
                 addProduct({
                     id: uniqueId,
                     name: name,
                     price: Number(price)
                 });
             } else {
                 console.error("Faltan datos para agregar al carrito");
             }
        });
    });
</script>

<style>
  /* --- ESTILOS (IGUAL QUE ANTES) --- */
  .product-card {
    position: relative;
    box-shadow: 8px 8px 0px var(--color-red, #dc2626);
    background-color: #111; 
    border: 2px solid #222;
    display: flex;
    flex-direction: column;
    height: 100%;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .product-card:hover { border-color: var(--color-red, #dc2626); }
  .card-upper { padding: 1.5rem 1.5rem 0 1.5rem; flex-grow: 1; }
  .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
  .product-name { font-size: 2.2rem; margin: 0; line-height: 0.9; text-transform: uppercase; color: white; font-weight: 900; }
  .badge-new { background-color: var(--color-red, #dc2626); color: black; font-size: 0.7rem; font-weight: 900; padding: 4px 8px; letter-spacing: 1px; transform: rotate(5deg); }
  .separator { height: 4px; width: 50px; background-color: var(--color-red, #dc2626); margin: 1rem 0; }
  .description { color: #aaa; font-size: 0.95rem; line-height: 1.4; margin-bottom: 1.5rem; }
  .customizer-panel { background-color: #0a0a0a; padding: 1rem 1.5rem; border-top: 2px solid var(--color-red, #dc2626); border-bottom: 1px solid #222; }
  .panel-label { font-size: 0.7rem; color: #555; letter-spacing: 2px; margin-bottom: 10px; font-weight: bold; }
  .selector-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .selector-row:last-child { margin-bottom: 0; }
  .option-label { font-size: 0.9rem; color: var(--color-red, #dc2626); font-weight: 900; letter-spacing: 1px; display: flex; align-items: center; gap: 5px; }
  .option-buttons { display: flex; gap: 5px; background: #1a1a1a; padding: 3px; border-radius: 4px; border: 1px solid #333; }
  .btn-selector { padding: 6px 12px; background: transparent; border: none; color: #777; font-size: 0.75rem; font-weight: bold; cursor: pointer; border-radius: 2px; transition: all 0.2s; }
  .btn-selector:hover { color: white; }
  .btn-selector.active { background-color: var(--color-red, #dc2626); color: black; font-weight: 900; box-shadow: 0 0 15px rgba(220, 38, 38, 0.4); }
  .card-footer { padding: 1.5rem; background-color: #151515; border-top: 1px solid #222; }
  .price-container { margin-bottom: 1rem; text-align: right; }
  .price-label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 2px; }
  .price { font-size: 2rem; font-weight: 900; color: white; letter-spacing: -1px; }
  .btn-add-cart { width: 100%; background-color: var(--color-red, #dc2626); border: none; color: white; padding: 1rem; cursor: pointer; font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; transition: all 0.2s; box-shadow: 0 4px 0px rgb(153, 27, 27); }
  .btn-add-cart:hover { transform: translateY(2px); box-shadow: 0 2px 0px rgb(153, 27, 27); background-color: rgb(239, 68, 68); }
  .btn-add-cart:active { transform: translateY(4px); box-shadow: none; }
</style>